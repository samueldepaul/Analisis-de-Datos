---
title: ""
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, echo=FALSE, message = FALSE}
#Aquí cargamos las librerías que usaremos
library(tidyverse)
library(knitr)
library(magick) #Para la visualización de imágenes
library(dplyr)
library(ggpol)
library(scales)
library(RColorBrewer)
library(patchwork)
library(ggridges)
library(factoextra)
library(cluster)
library(ggalt)
library(tidyr)
#install.packages("devtools")
#devtools::install_github("ricardo-bion/ggradar")
library(ggradar)
```
\begin{titlepage}
\centering
{\bfseries\LARGE Análisis de Datos\par}
\vspace{3cm}
{\scshape\Huge 
Biomarcadores prematuros\\de la enfermedad de Parkinson\par}
\vspace{1cm}
\vfill
{\Large Autores: \par}
{\Large Pau Vives López, Harold Cruz Lorenzo,\\ Samuel de Paúl Smith \par}
\vfill
```{r image_grobs3, fig.show = "hold", out.width = "40%", fig.align = "center",echo=FALSE}
Captura <- image_read("logouib.png")
image_write(Captura, "logouib.png")
knitr::include_graphics(c("logouib.png"))
```
\end{titlepage}

\newpage
# Contextualización, objetivos y descripción de los datos

La enfermedad de Parkinson es un transtorno neurodegenerativo crónico caracterizado por los temblores, rigidez y disminución de la mobilidad. Esta enfermedad se debe a un déficit en la secreción de dopamina, hormona liberada por las terminaciones nerviosas de la sustancia negra. A veces comienza con un temblor apenas perceptible en una sola mano. En las etapas iniciales de la enfermedad de Parkinson, el rostro puede tener una expresión leve o nula. Es posible que los brazos no se balanceen al caminar. El habla puede volverse suave o incomprensible. Los síntomas de la enfermedad de Parkinson se agravan a medida que la enfermedad progresa con el tiempo.

A pesar de que la enfermedad de Parkinson no tiene cura, los medicamentos pueden reducir o atenuar notablemente los síntomas. En ocasiones, el médico puede sugerir realizar una cirugía para regular determinadas zonas del cerebro. 

Esta enfermedad representa el segundo trastorno neurodegenerativo por su frecuencia, sólo por detrás del Alzheimer. Está extendida por todo el mundo y puede desarrollarse en ambos sexos, afectando a entre un 1% a un 2% de la población mayor de 60 años.

```{r image_grobs, fig.show = "hold", out.width = "35%", fig.align = "center", fig.cap="\\label{fig:figs}Test de la espiral en pacientes sanos (izquierda) y pacientes con Parkinson (derecha)",echo=FALSE}
img1 <- image_read("spiral_healthy.png")
img1 <- image_border(img1, "white", "100x20")
img2 <- image_read("spiral_parkinson.png")
img2 <- image_border(img2, "white", "100x20")
image_write(img1, "img1.png")
image_write(img2, "img2.png")
knitr::include_graphics(c("img1.png","img2.png"))
```


Hemos obtenido el dataset con el que vamos a trabajar de la web Kaggle, bajo el título "Early Biomarkers of Parkinson's Disease", que podría traducirse como "Biomarcadores prematuros de la enfermedad de Parkinson" Los datos provienen originalmente de un paper publicado a principios de 2017 en nature.com, que puede consultarse en el enlace https://www.nature.com/articles/s41598-017-00047-5.pdf

Hemos elegido este tema porque nos parece que la investigación científica y médica es una área que se beneficia mucho del análisis de datos ya que abunda la información puesto que se realizan todo tipo de pruebas y diagnósticos a los pacientes. Además, estudios de este tipo están enfocados en mejorar la calidad de vida de los pacientes afectados por la enfermedad, y claramente nos parece que merece la pena trabajar de cara a éste objetivo.

El conjunto de datos incluye 30 pacientes con enfermedad de Parkinson (EP) temprana no tratada, 50 pacientes con trastorno de conducta del sueño REM (RBD), que tienen un alto riesgo de desarrollar la enfermedad de Parkinson, y 50 controles sanos (HC).

Todos los pacientes fueron evaluados clínicamente por un neurólogo profesional con experiencia en trastornos del movimiento. Todos los sujetos fueron examinados durante una sola sesión con un especialista del habla. Éstos realizaron la lectura de un texto estandarizado, fonéticamente equilibrado de 80 palabras y monólogos sobre sus intereses, trabajo, familia o actividades actuales durante aproximadamente 90 segundos. Las características del habla fueron analizadas automáticamente por Jan Hlavnička et al.

Con el análisis de éste conjunto de datos se pretende:
\begin{itemize}
  \item Hallar biomarcadores de la enfermedad de Parkinson en los distintos pacientes estudiados
  \item Clasificar a los pacientes en grupos de riesgo 
  \item Distinguir qué rasgos están más estrechamente relacionados con el desarrollo del Parkinson
\end{itemize}

\newpage
# Descripción de los datos

```{r, echo=FALSE}
data <- read.csv("dataset.csv")
data <- as_tibble(data)
```
En el dataset original las variables tienen nombres muy largos y engorrosos por lo que primero las renombraremos, para poder trabajar con ellas con mas facilidad, y a continuación detallaremos la información que aporta cada una.
```{r, echo = FALSE}
names(data)[1] <- "code"
names(data)[2] <- "age"
names(data)[3] <- "gender"
names(data)[4] <- "history"
names(data)[5] <- "onset"
names(data)[6] <- "duration"
names(data)[7] <- "antidepressant"
names(data)[8] <- "antiparkinsonian"
names(data)[9] <- "antipsychotic"
names(data)[10] <- "benzodiazepine"
names(data)[11] <- "levodopa"
names(data)[12] <- "clonazepam"
names(data)[13] <- "HY_scale"
names(data)[14] <- "UPDRSIII"
names(data)[15] <- "X18"
names(data)[16] <- "X19"
names(data)[17] <- "X20-head"
names(data)[18] <- "X20-RUE"
names(data)[19] <- "X20-LUE"
names(data)[20] <- "X20-RLE"
names(data)[21] <- "X20-LLE"
names(data)[22] <- "X21-RUE"
names(data)[23] <- "X21-LUE"
names(data)[24] <- "X22-neck"
names(data)[25] <- "X22-RUE"
names(data)[26] <- "X22-LUE"
names(data)[27] <- "X22-RLE"
names(data)[28] <- "X22-LLE"
names(data)[29] <- "X23-RUE"
names(data)[30] <- "X23-LUE"
names(data)[31] <- "X24-RUE"
names(data)[32] <- "X24-LUE"
names(data)[33] <- "X25-RUE"
names(data)[34] <- "X25-LUE"
names(data)[35] <- "X26-RLE"
names(data)[36] <- "X26-LLE"
names(data)[37] <- "X27"
names(data)[38] <- "X28"
names(data)[39] <- "X29"
names(data)[40] <- "X30"
names(data)[41] <- "X31"
names(data)[42] <- "EST"
names(data)[43] <- "RST"
names(data)[44] <- "AST"
names(data)[45] <- "DPI"
names(data)[46] <- "DVI"
names(data)[47] <- "GVI"
names(data)[48] <- "DUS"
names(data)[49] <- "DUF"
names(data)[50] <- "RLR"
names(data)[51] <- "PIR"
names(data)[52] <- "RSR"
names(data)[53] <- "LSE"
names(data)[54] <- "EST-M"
names(data)[55] <- "RST-M"
names(data)[56] <- "AST-M"
names(data)[57] <- "DPI-M"
names(data)[58] <- "DVI-M"
names(data)[59] <- "GVI-M"
names(data)[60] <- "DUS-M"
names(data)[61] <- "DUF-M"
names(data)[62] <- "RLR-M"
names(data)[63] <- "PIR-M"
names(data)[64] <- "RSR-M"
names(data)[65] <- "LSE-M"
```


El dataset consta de las siguientes variables para cada una de las observaciones:

**code**: (carácter) Contiene un código de identificación para cada paciente.\
**age**: (numérica) Edad de cada paciente en años. \
**gender:** (categórica con 2 niveles) Género del paciente.\
**history**: (categórica de 2 niveles) Variable que indica si el paciente tiene familiares con Parkinson.\
**onset**: (numérica) Edad del paciente al inicio de la enfermedad, en años.\
**duration**: (numérica) Duración de la enfermedad desde los primeros síntomas, en años.\
**antidepr**: (categórica con 10 niveles): Terapia con Antidepresivos del paciente, en caso afirmativo se especifica cuál.\
**antipark**: (categórica con 1 nivel): Medicación antiparkinsoniana del paciente.\
**antipsych**: (categórica con 1 nivel): Medicación antipsicótica del paciente.\
**benzodiazepine**: (Categórica con 4 niveles): Medicación con benzodiazepinas del paciente, en caso afirmativo se especifica cuál.\
**levodopa**: (numérica) Cantidad en miligramos del consumo de Levodopa diario del paciente.\
**clonazepam**: (numérica) Cantidad en miligramos del consumo de Clonazepam diario del paciente.\
**HY_scale**: (categórica con 7 niveles) Mide el estado de la discapacidad funcional asociada a la enfermedad de Parkinson en la escala Hoehn-Yahr\
**UPDRSIII**: (numérica) Puntuación total en la "UNIFIED PARKINSON'S DISEASE RATING SCALE "\

### Evaluación Motora y Cognitiva:

Las siguientes variables son los resultados de unas pruebas realizadas exclusivamente a los sujetos que no están completamente sanos, relacionadas con esta enfermedad (por ejemplo, mediciones sobre los temblores en un brazo)

Hay variables en este grupo que contienen resultados de una misma prueba, pero para direntes regiones del cuerpo. Por tanto, para describir todas las variables de una manera resumida definiremos las pruebas realizadas y el significado de las abreviaturas que acompañan a la variable (por ejemplo, la variable "X19-LRU" es el resultado de la prueba "X19" sobre la zona "LRU" del cuerpo)

NOTA: Todas estas variables son de tipo categórico, tomando como valores números enteros a partir del $0$ que miden las complicaciones que experimenta el paciente para realizar dicha prueba.


 - *Pruebas:*
 
 Éstas variables miden diferentes pruebas de la escala UPDRS III, que introducida en 1987, es la escala más ámpliamente utilizada para el análisis de la situación clínica de un paciente parkinsoniano.

**X18**: Pronunciación \
**X19**: Expresión facial\
**X20**: Temblores en reposo\
**X21**: Temblor de acción o postural\
**X22**: Rigidez\
**X23**: Golpes con la punta de los dedos\
**X24**: Movimientos de la mano\
**X25**: Movimientos rápidos alternados\
**X26**: Agilidad en piernas\
**X27**: Levantarse de una silla\
**X28**: Postura\
**X29**: Forma de andar\
**X30**: Estabilidad postural\
**X31**: Bradicinesia y hipocinesia corporal\


 - *Zonas del cuerpo*

**RUE**: ("Right Upper Extremity") Hace referencia a la extremidad superior derecha.\
**LUE**:("Left Upper Extremity") Hace referencia a la extremidad superior izquierda.\
**RLE**:("Right Lower Extremity") Hace referencia a la extremidad inferior derecha.\
**LLE**:("Left Lower Extremity") Hace referencia a la extremidad inferior izquierda.\
**head**: Cabeza\
**neck**: Cuello

### Mediciones acústicas:
```{r image_grobs2, fig.show = "hold", out.width = "95%", fig.align = "center", fig.cap="\\label{fig:figs}Resumen de las variables utilizadas",echo=FALSE}
Captura <- image_read("Captura.png")
image_write(Captura, "Captura.png")
knitr::include_graphics(c("Captura.png"))
```
(En el dataset, éstas variables se repiten, ya que se han realizado dos mediciones, una durante la lectura de un texto fonéticamente equilibrado y otra durante un monólogo de unos 90 segundos. Las variables correspondientes al monólogo tienen la terminación "-M")

**EST**: (numérica) Mide la heterogeneidad en el habla en términos de la ocurrencia de intérvalos de sonoridad, insonoridad, pausas y respiraciraciones. (este valor se haciendo uso de la entropia de Shannon)\
**RST**: (numérica) Ratio de la sincronización del habla. \
**AST**: (numérica) Mide la aceleración o deceleración en la velocidad del habla.\
**DPI**: (numérica) Mide la media de la duración de los intérvalos de pausas de cada paciente.\
**DVI**: (numérica) Mide la duración media de los intérvalos de voz.\
**GVI**: (numérica) Separación media entre intérvalos de voz.\
**DUS**: (numérica) Duración media de las consonantes oclusivas.\
**DUF**: (numérica) Mide la diferencia entre el 2º Coeﬁciente Cepstral en las Frecuencias de Mel.\
**RLR**: (numérica) Sonoridad relativa de la respiración\
**PIR**: (numérica) Intervalos de pausa por respiración\
**RSR**: (numérica) Tasa de respiración del habla.\
**LRE**: (numérica)Latencia del intercambio respiratorio.\

\newpage

### Dataset Secundario para Series Temporales

Por completitud respecto al temario de la asignatura, tomamos un segundo dataset con variables evaluadas a lo largo del tiempo para trabajar Series Temporales.

Éste segundo dataset tiene como título "Health Indicator - Parkinson's Disease - Age-Standardized Incidence Rate" y lo hemos obtenido a través de la web del Ministerio de Sanidad de Alberta, Canadá. Puede consultarse en el siguiente enlace: http://www.ahw.gov.ab.ca/IHDA_Retrieval/selectSubCategory.do.

En el dataset figuran diversas variables poblacionales relacionadas con la enfermedad de Parkinson tomadas a la población de Alberta entre los años 2004 y 2020. Cambiamos el nombre de las variables porque son largos y engorrosos. Además, el dataset está dividido en zonas, y subzonas y regiones más pequeñas sucesivamente; sin embargo, a nosotros simplemente nos interesará estudiar las zonas de: Alberta, en general, y las subzonas: South Zone, Calgary Zone, Central Zone, Edmonton Zone y North Zone.

Finalmente, las variables de las que consta el dataset son:

```{r, echo=FALSE}
data2 <- read.csv("dataset2.csv")
data2 <- as_tibble(data2)
```

```{r, echo = FALSE}
temp = data2$Year
data2$Year = data2$Geography
data2$Geography = temp
```

```{r, echo = FALSE}
names(data2)[1] <- "year"
names(data2)[2] <- "region"
names(data2)[3] <- "sex"
names(data2)[4] <- "incidence_rate"
names(data2)[5] <- "incident_cases"
names(data2)[6] <- "pop_at_risk"
names(data2)[7] <- "SE"
names(data2)[8] <- "SS"
names(data2)[9] <- "ABr"
```
```{r, echo=FALSE}
regions <- c("AB", "Z1", "Z2", "Z3", "Z4", "Z5")
idx <- data2$region %in% regions
data2 <- data2[idx,]
```


**year**: (numérica) Año en que se realiza la medición.\
**region**: (categórica con 8 niveles) Región en la que se mide. \
**sex:** (categórica con 3 niveles) sexo del habitante.\
**incidence_rate**: (numérica) Tasa de incidencia (estandarizada por edad)\
**incident_cases**: (numérica) Casos de Parkinson (para todas las edades)\
**pop_at_risk**: (numérica) Población en riesgo de padecer Parkinson.\
**SE**: (numérica): "standard error", error estándar.\
**SS**: (numérica): "standard score", puntuación estándar.\
**ABr**: (numérica): "Alberta Rate".\

# Limpieza de datos y valores perdidos:

En el dataset principal, tenemos una gran cantidad de variables categóricas, para trabajar con ellas de manera óptima primero las transformaremos a factores con sus respectivos niveles.

Una vez hecho esto, notamos que tenemos muchas variables en que aparecen guiones "-" por varias razones, y lo que haremos será transformar todos estos guiones en \textit{NA's}, y seguidamente explicar el motivo para que éstos datos sean faltantes.

```{r, echo = FALSE, warning=FALSE}
#Transformamos las variables pertinentes en factores
data$gender = as_factor(data$gender)
data$history = as_factor(data$history)
data$onset = as.numeric(data$onset)
data$UPDRSIII = as.integer(data$UPDRSIII)
data$duration = as.numeric(data$duration)
data$antidepressant = as_factor(data$antidepressant)
data$antiparkinsonian = as_factor(data$antiparkinsonian)
data$antipsychotic = as_factor(data$antipsychotic)
data$benzodiazepine = as_factor(data$benzodiazepine)
data$HY_scale = as_factor(data$HY_scale)
data$X18 = as_factor(data$X18)
data$X19 = as_factor(data$X19)
data$`X20-head` = as_factor(data$`X20-head`)
data$`X20-RUE` = as_factor(data$`X20-RUE`)
data$`X20-LUE` = as_factor(data$`X20-LUE`)
data$`X20-RLE` = as_factor(data$`X20-RLE`)
data$`X20-LLE` = as_factor(data$`X20-LLE`)
data$`X21-RUE` = as_factor(data$`X21-RUE`)
data$`X21-LUE` = as_factor(data$`X21-LUE`)
data$`X22-neck` = as_factor(data$`X22-neck`)
data$`X22-RUE` = as_factor(data$`X22-RUE`)
data$`X22-LUE` = as_factor(data$`X22-LUE`)
data$`X22-RLE` = as_factor(data$`X22-RLE`)
data$`X22-LLE` = as_factor(data$`X22-LLE`)
data$`X23-RUE` = as_factor(data$`X23-RUE`)
data$`X23-LUE` = as_factor(data$`X23-LUE`)
data$`X24-RUE` = as_factor(data$`X24-RUE`)
data$`X24-LUE` = as_factor(data$`X24-LUE`)
data$`X25-RUE` = as_factor(data$`X25-RUE`)
data$`X25-LUE` = as_factor(data$`X25-LUE`)
data$`X26-RLE` = as_factor(data$`X26-RLE`)
data$`X26-LLE` = as_factor(data$`X26-LLE`)
data$X27 = as_factor(data$X27)
data$X28 = as_factor(data$X28)
data$X29 = as_factor(data$X29)
data$X30 = as_factor(data$X30)
data$X31 = as_factor(data$X31)

#Eliminamos los guiones e introducimos NA's
levels(data$history)[3] = NA
data$onset[81:130] = NA
data$duration[81:130] = NA
data$HY_scale[31:130] = NA
data[81:130, 14:41] = NA
#Ésta última instrucción convierte en NA todos los valores 
#de las pruebas X18 - X31 en las filas de los pacientes sanos
```

Las variables \textit{history}, \textit{onset} y \textit{duration} tienen \textit{NA's} a partir de la observación 81 ya que los pacientes 81-130 son los controles sanos y por tanto no tiene sentido tomar mediciones acerca de su enfermedad si no tienen ninguna. Similarmente, la variable \textit{HY.scale} toma el valor \textit{NA} a partir de la observación 31, ya que los pacientes 1-30 son los que padecen la enfermedad de Parkinson y la escala H&Y se utiliza para medir el avance de los síntomas de dicha enfermedad. 

Finalmente, hay una gran concentración de \textit{NA}'s en las columnas correspondientes a las pruebas X18 - X30 de la escala UPDRS III, y esto se debe a que las pruebas sólo se han realizado a los pacientes que padecen la enfermedad de Parkinson o trastorno de conducta del sueño REM, es decir, en las primeras 80 observaciones.

Con el objetivo de limpiar los datos lo máximo posible, eliminaremos algunas variables que no aportan información en absoluto. Durante la recogida de datos se tomaron datos de los pacientes que han resultado no ser útiles para la investigación. Las variables \textit{antiparkinsonian}, \textit{antipsychotic} y \textit{levodopa}, que miden si el paciente se medica con ciertos medicamentos, tienen el mismo valor para las 130 observaciones (No, No y 0mg/día respectivamente). De modo que las eliminamos del conjunto de datos por ser supérfluas.

```{r, echo = FALSE}
data = select(data , -antiparkinsonian, -antipsychotic, -levodopa)
```

Otra cosa que nos facilitará trabajar con los datos será tener una variable que nos indique qué enfermedad padece un paciente (si es que padece alguna). Ésta información ya se encuentra en la variable \textit{code}, que nos da el código del paciente. Sin embargo, los códigos incluyen también un número indentificativo para el paciente por lo que no podemos trabajar con ésta variable. Lo que haremos será utilizar la función \textit{separate()} para dividir la variable \textit{code} en dos variables nuevas, una que conservará el mismo nombre y únicamente guardará el número asignado a cada paciente, y otra a la que llamaremos \textit{disease} que indicará qué enfermedad padece el paciente; enfermedad de Parkinson (EP), trastorno de conducta del sueño REM (RBD) o  si son controles sanos (HC).

```{r, echo = FALSE}
data = separate(data, code, into = c("disease", "code"), sep = "(?<=[A-Za-z])(?=[0-9])") 
temp = data$disease
data$disease = data$code
data$code = temp
names(data)[1] = "code"
names(data)[2] = "disease"
#tiene que haber una forma más fina de hacer esto
```


# Fase Descriptiva: Visualización y Resúmen de variables.

Vamos a representar gráficamente las tres variables \textit{age, gender, disease} para poner en perspectiva algunas de las cualidades más genéricas de los pacientes evaluados:

```{r, echo = FALSE, fig.show = "hold", fig.height = 3, fig.align = "center"}
#install.packages("patchwork")

p1 <- ggplot(data = data) +
      geom_bar(mapping = aes(x = age), fill = "skyblue") +
      xlab("Edad de los Pacientes") +
      ylab("Cantidad de Pacientes") +
      theme(legend.position = "none")

p2 <- ggplot(data = data) +
      geom_bar(mapping = aes(x = gender, fill = gender)) +
      xlab("Sexo de los Pacientes") +
      ylab("Cantidad de Pacientes") +
      theme(legend.position = "none")


p3 <- ggplot(data = data) +
      geom_bar(mapping = aes(x = disease, fill = disease)) +
      xlab("Enfermedad Padecida") +
      ylab("Cantidad de Pacientes") +
      theme(legend.position = "none")

p1+p2+p3
```
Por tanto vemos claramente que las observaciones se tratan de pacientes de edades comprendidas mayormente entre 50 y 80 años, donde predominan los hombres (aproximadamente una mujer por cada 4 hombres). Además confirmamos la distribución por enfermedad padecida mencionada en la contextualización del trabajo; 50 controles sanos (HC), 30 pacientes que padecen enfermedad de Parkinson (PD) y 50 que padecen trastorno de la conducta del sueño REM (RBD).

Ahora, lo que queremos hacer es, para cada una de las mediciones realizadas a los pacientes durante la lectura de un texto fonéticamente equilibrado y durante la exposición de un monólogo de 90 segundos, comparar los valores obtenidos en función de la variable \textit{disease}, es decir, comparar según si los pacientes son enfermos de Parkinson, de trastorno de conducta del sueño REM o controles sanos. (Representamos gráficamente aquellas variables en que se se aprecie una diferencia fácil de observar).

```{r, echo = FALSE, fig.show = "hold", fig.height = 2.5, warning=FALSE, fig.align = "center"}
# plot the distribution of salaries 
# by rank using jittering
#install.packages("ggpol")

p1_rst <- ggplot(data, 
       aes(x = disease, 
           y = RST, 
           fill = disease)) +
  geom_boxjitter(color="black",
                 jitter.color = "darkgrey",
                 errorbar.draw = TRUE) +
  labs(title = "Variable RST", 
       subtitle = "(Lectura de texto)",
       x = "",
       y = "") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(100,450)

p2_rst <- ggplot(data, 
       aes(x = disease, 
           y = `RST-M`, 
           fill = disease)) +
  geom_boxjitter(color="black",
                 jitter.color = "darkgrey",
                 errorbar.draw = TRUE) +
  labs(title = "Variable RST", 
       subtitle = "(Monólogo corto)",
       x = "",
       y = "") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(100,450)

p1_rst + p2_rst 
```

```{r, echo = FALSE, warning=FALSE, fig.show = "hold", fig.height = 2.5, fig.align = "center"}
p1_dpi <- ggplot(data, 
       aes(x = disease, 
           y = DPI, 
           fill = disease)) +
  geom_boxjitter(color="black",
                 jitter.color = "darkgrey",
                 errorbar.draw = TRUE) +
  labs(title = "Variable DPI", 
       subtitle = "(Lectura de texto)",
       x = "",
       y = "") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(50,650)

p2_dpi <- ggplot(data, 
       aes(x = disease, 
           y = `DPI-M`, 
           fill = disease)) +
  geom_boxjitter(color="black",
                 jitter.color = "darkgrey",
                 errorbar.draw = TRUE) +
  labs(title = "Variable DPI", 
       subtitle = "(Monólogo corto)",
       x = "",
       y = "") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(50,650)

p1_dpi + p2_dpi
```

```{r, echo = FALSE, fig.show = "hold", fig.height = 2.5, fig.align = "center", warning=FALSE}
p1_dus <- ggplot(data, 
       aes(x = disease, 
           y = DUS, 
           fill = disease)) +
  geom_boxjitter(color="black",
                 jitter.color = "darkgrey",
                 errorbar.draw = TRUE) +
  labs(title = "Variable DUS", 
       subtitle = "(Lectura de texto)",
       x = "",
       y = "") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(5,60)

p2_dus <- ggplot(data, 
       aes(x = disease, 
           y = `DUS-M`, 
           fill = disease)) +
  geom_boxjitter(color="black",
                 jitter.color = "darkgrey",
                 errorbar.draw = TRUE) +
  labs(title = "Variable DUS", 
       subtitle = "(Monólogo corto)",
       x = "",
       y = "") +
  theme_minimal() +
  theme(legend.position = "none") +
  ylim(5,60)

p1_dus + p2_dus
```

En los boxplots anteriores podemos ver que en una primera inspección no muy detallada de las variables, hay 3 en que se observa una diferencia entre los grupos.
Empezamos analizando la variable $RST$. En el diagrama de cajas podemos ver que el valor medio de ésta variable es mayor para los pacientes sanos que para los enfermos (tanto de Párkinson como de Trastorno de la conducta del sueño REM). Esto ocurre tanto en las mediciones realizadas durante la lectura de un texto fonéticamente estandarizado y las realizadas durante un monólogo corto. Además, los outliers que se observan en los grupos PD y RBD se sitúan prácticamente en su totalidad, por debajo de la línea que marca $Q1-1.5*IRQ$

En el la segunda figura analizamos la variable $DPI$. En éste caso destaca el hecho de que la media para el grupo de los pacientes sanos sea menor que la de los otros dos grupos de pacientes. Además, las observaciones de los grupos PD y RBD están más dispersas, cosa que aumenta el rango inter-cuartílico. Esto se aplica tanto a las mediciones de lectura como a las de monólogo.

Finalmente, en la tercera figura se representa la variable $DUS$. De nuevo, observamos que, en la lectura como en el monólogo, el valor medio de ésta variable es menor para los pacientes sanos que para los pacientes que padecen Párkinson o Trastorno de la conducta del sueño REM. No observamos ninguna diferencia muy notable en cuanto a la dispersión de los datos.  
\newpage
La variable \textit{HY.scale} nos indica el grado de avance de los síntomas del Parkinson. Vamos a observar si los síntomas avanzan más rápido dependiendo de la edad o sexo del paciente:
```{r, echo = FALSE, fig.show = "hold", fig.height = 3, fig.align = "center", message = FALSE}
plotdata <- data[1:30,] %>%
  group_by(gender, HY_scale) %>%
  summarize(n = n()) %>% 
  mutate(pct = n/sum(n),
         lbl = scales::percent(pct))

# create segmented bar chart
# adding labels to each segment

ggplot(plotdata, 
       aes(x = gender,
           y = pct,
           fill = HY_scale)) + 
  geom_bar(stat = "identity",
           position = "fill") +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     label = percent) +
  geom_text(aes(label = lbl), 
            size = 3, 
            position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Porcentaje", 
       fill = "Valor en la escala H&Y",
       x = "Género del paciente",
       title = "Valor de H&Y por género.") +
  theme_minimal()

```

```{r, echo = FALSE, fig.show = "hold", fig.height = 3, fig.align = "center", message = FALSE}
ggplot(data[1:30,], 
       aes(x = age, 
           fill = HY_scale)) +
  geom_density(alpha = 0.4) +
  labs(title = "Distribución de Edad por valor en la escala H&Y",
       y = "Densidad", 
       fill = "Valor en la escala H&Y",
       x = "Edad del Paciente")
```
Por lo tanto, en el primer gráfico vemos que, en lo que respecta al avance de los síntomas, el porcentaje de hombres con una escala de 1.5 en H&Y (síntomas leves) es menor que el de mujeres. A su vez, el porcentaje de hombres en escala 2.5 (síntomas más graves) es mayor. De ésta manera observamos que los síntomas de la enfermedad de Parkinson afectan de forma más grave a los hombres que a las mujeres.

Por otra parte, en el segundo gráfico vemos, para cada valor en la escala H&Y, la distribución de las edades de los pacientes afectados. Se aprecia que los pacientes que están en los valores 2 y 2.5 de la escala H&Y tienen una distribución de edades muy parecida. Sin embargo, observamos claramente que los pacientes que están en el valor 1.5, es decir, los de síntomas más leves, tienen una edad significativamente más baja que los otros dos grupos. Así, constatamos que los pacientes más jóvenes presentan una sintomatología más leve.

\newpage
Queremos comprobar también si las personas que padecen Parkinson, tienen una puntuación más alta en la escala de UPDRSIII que aquellas que padecen trastorno de la conducta del sueño REM.

```{r,echo = FALSE, fig.show = "hold", fig.height = 2.5, fig.align = "center"}
datos2 = data[1:80,]
datos2$UPDRSIII = as.numeric(datos2$UPDRSIII)
ggplot(datos2, aes(x = disease, y = UPDRSIII, fill = disease)) +
  geom_boxplot()
```

Y como intuíamos, los pacientes con Parkinson tienen valores más altos en este test que los pacientes que padecen transtorno de sueño (basta fijarse en que la media de los primeros queda por encima del valor límite (?) del otro grupo). Además, también podemos fijarnos en que los pacientes con Párkinson tienen una dispersión considerable, mucho mayor que en el grupo de pacientes con transtorno de sueño. 

Podríamos pensar que la causa de la alta dispersión de los resultados del test en pacientes de Parkinson se deba a una diferencia muy marcada en la edad de los pacientes seleccionados. Por tanto podemos comprobar cómo se han distribuido los resultados en función de la edad de los pacientes, para ver si hay una tendencia marcada.

```{r, echo = FALSE, fig.height=3}
p1 = ggplot(datos2, aes(age, UPDRSIII))+
  geom_point()

p2 = ggplot(datos2, aes(duration, UPDRSIII))+
  geom_point()

p1+p2
```

Pero como podemos ver en el gráfico de la izquierda, no parece que exista tal tendencia. Además, en el gráfico de la derecha hemos mirado a ver si el resultado del test se ve afectado por el tiempo total que llevan los pacientes con dicha enfermedad y tampoco parece existir ninguna tendencia ("no se si deberíamos explicar de onde sale la variable Dif pero la había creado solo para esto").

```{r, echo=FALSE, fig.height=3, message=FALSE}
ggplot(data) +
  geom_smooth(mapping = aes(x = age, y = DPI, color = disease), se = FALSE)
```

No se que quiere decir pero parece que solo sube pa los enfermitos
\newpage
A continuación, realizaremos unos diagramas "de telaraña" o "de radar" que nos permitirán ver de forma clara el perfil de cada grupo de pacientes respecto a las pruebas del habla a las que se han sometido. En primer lugar tomaremos los datos recogidos durante la lectura de un texto fonéticamente estandarizado y siguidamente lo haremos para los datos recogidos durante un monólogo breve.

```{r, echo = FALSE, message = FALSE, warning=FALSE, fig.width=10, fig.width=6, fig.align = "center", fig.show = "hold", fig.show='hide', results='hide'}
#Vamos a hacer un diagrama de telaraña para observar gráficamente la diferéncia entre los 3 tipos de pacientes al realizar las pruebas del habla:
par(mfrow=c(1,3))
park <- colMeans(data[data$disease == "PD", 40:63])
rbd <- colMeans(data[data$disease == "RBD", 40:63])
control <- colMeans(data[data$disease == "HC", 40:63])

spider = tibble(park = park,
                rdb = rbd,
                control = control)

spider_transpose <- as_tibble(cbind(nms = names(spider), t(spider)))

names(spider_transpose) = c("Disease","EST", "RST", "AST", "DPI", "DVI", "GVI", "DUS", "DUF", "RLR", "PIR", "RSR", "LSE", "EST-M", "RST-M", "AST-M", "DPI-M", "DVI-M", "GVI-M", "DUS-M", "DUF-M", "RLR-M", "PIR-M", "RSR-M", "LSE-M")

spider_transpose[] <- lapply(spider_transpose, function(x) as.numeric(x))
spider_transpose$Disease = c("Parkinson", "RBD", "Controles Sanos")

plotdata3 <- spider_transpose %>%
  rename(group = Disease) %>%
  mutate_at(vars(-group),
            funs(rescale))

png(file="plot1.png", width = 640 ,height = 320, res = 100)
plotdata3[,1:13] %>%
  ggradar(base.size = 8,
        grid.label.size = 2.5,
        axis.label.size = 3, 
        group.point.size = 2,
        group.line.width = 1,
        legend.text.size= 2,
        group.colours = c("lightgreen", "red", "orange"),
        plot.legend = FALSE) +
    facet_wrap(group~.)
dev.off()


png(file="plot2.png", width = 640 ,height = 320)
plotdata3[,c(1,14:25)] %>%
  ggradar(base.size = 8,
        grid.label.size = 2.5,
        axis.label.size = 3, 
        group.point.size = 2,
        group.line.width = 1,
        legend.text.size= 2,
        group.colours = c("lightgreen", "red", "orange"),
        plot.legend = FALSE) +
    facet_wrap(group~.)
dev.off()
```

```{r, echo = FALSE, fig.align='center'}
crop <- function(im, left = 0, top = 0, right = 0, bottom = 0) {
  d <- dim(im[[1]]); w <- d[2]; h <- d[3]
  image_crop(im, glue::glue("{w-left-right}x{h-top-bottom}+{left}+{top}"))
}
"plot1.png" %>%
  image_read() %>%
  crop(top = 45, bottom = 45)

#Captura <- image_read("plot1.png")
#image_write(Captura, "plot1.png")
#knitr::include_graphics(c("plot1.png"))
```

En la figura anterior podemos observar que, en lo que respecta a ésta prueba, los Controles Sanos se caracterizan por valores altos en las variables $PIR$ y $RST$, y un valor particularmente bajo de $DUS$. Por otro lado, los pacientes que padecen la enfermedad de Parkinson se distinguen del resto por un valor alto en la variable $DVI$ y destacan también por un valor más bajo que el del resto de grupos de $RSR$.
Finalmente, los pacientes que padecen trastorno de la conducta del sueño REM, tienen valores notablemente altos de $AST, GVI$ y $RLR$, mientras que, a diferencia de los otros dos grupos, el valor de $EST$ y $LSE$ se mantiene muy bajo.

A continuación tomamos los datos recogidos durante el monólogo breve:
```{r, echo=FALSE, , fig.align='center'}
"plot2.png" %>%
  image_read() %>%
  crop(top = 45, bottom = 45)
#Captura <- image_read("plot2.png")
#image_write(Captura, "plot2.png")
#knitr::include_graphics(c("plot2.png"))
```

Interpretemos los gráficos en este caso:
Los pacientes de control sanos tienen, al igual que en el gráfico anterior (de la lectura de un texto) valores notablemente altos de $EST$, $RST$ y $PIR$. Además, observamos valor alto de la variable $GVI$ así como un valor bajo de $DUF$ y $DVI$.
Por otro lado, los pacientes de Parkinson se caracteriazan porque el valor de $LSE$ resulta especialmente alto y el de $RLR$ especialmente bajo. Finalmente, los pacientes con trastorno de la conducta del sueño REM destacan en ésta ocasión por su valor de $AST$, que en comparación con el de los otros dos grupos es muy bajo.

De ésta forma hemos encontrado cómo las variables recogidas en éstas dos pruebas pueden caracterizar a los diferentes grupos de pacientes y éstas relaciones podrían tenerse en cuenta a la hora de evaluar el riesgo de un paciente de padecer Parkinson.


\newpage

Estudiaremos también si aquellos pacientes toman algún tipo de medicamento presentan un menor valor en la escala UPDRS III, es decir [...]
```{r, echo = FALSE, fig.show = "hold", fig.height = 3, fig.align = "center", message = FALSE}
#install.packages("ggridges")

#No distinguiremos entre medicamentos específicos y reduciremos los niveles de los
#factores únicamente a SÍ/NO 

data_nomed <- data
data_nomed <- mutate(data_nomed, benzodiazepine = fct_collapse(benzodiazepine,
    Yes = levels(data_nomed$benzodiazepine)[2:4]))
data_nomed <- mutate(data_nomed, antidepressant = fct_collapse(antidepressant,
    Yes = levels(data_nomed$antidepressant)[2:10]))

p1_nomed <- ggplot(data_nomed[1:80, ], 
       aes(x = as.numeric(UPDRSIII), 
           y = antidepressant, 
           fill = antidepressant)) +
  geom_density_ridges() + 
  theme_ridges() +
  labs(title = "Valor en la escala UPDRS III respecto a la medicación", 
       x = "Valor escala UPDRS III",
       y = "Antidepresivos") +
  theme(legend.position = "none")

p2_nomed <- ggplot(data_nomed[1:80, ], 
       aes(x = as.numeric(UPDRSIII), 
           y = benzodiazepine, 
           fill = benzodiazepine)) +
  geom_density_ridges() + 
  theme_ridges() +
  labs(x = "Valor escala UPDRS III",
       y = "Benzodiazepinas") +
  theme(legend.position = "none")

p1_nomed+p2_nomed
```
\textbf{[...] (no sé si sirve de algo la verdad)}
\newpage

```{r, echo = FALSE, fig.show = "hold", fig.height = 3, fig.align = "center", message = FALSE, warning=FALSE}
plotdata <- data2[data2$sex == "BOTH",]
plotdata <- plotdata[18:102,]
# plot pop at risk by year, for each region
ggplot(plotdata, aes(x=year, y = incidence_rate)) +
  geom_line(color="grey") +
  geom_point(color="blue") +
  facet_wrap(~region) + 
  theme_minimal(base_size = 9) +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1)) +
  labs(title = "Evolución del Ratio de incidencia",
       x = "Año",
       y = "Ratio de Incidencia")
```
```{r, echo = FALSE, fig.show = "hold", fig.height = 3, fig.align = "center", message = FALSE, warning=FALSE}
# subset data
plotdata2 <- filter(data2,
                        sex == "BOTH"  &
                        year %in% c(2004, 2020)) %>%
  select(region, year, pop_at_risk)

# convert data to wide format
plotdata2_wide <- spread(plotdata2, year, pop_at_risk)
names(plotdata2_wide) <- c("region", "y2004", "y2020")

# create dumbbell plot
ggplot(plotdata2_wide[2:6,], 
       aes(y = region,
           x = y2004,
           xend = y2020)) +  
  geom_dumbbell(size = 1.2,
                size_x = 3, 
                size_xend = 3,
                colour = "grey", 
                colour_x = "blue", 
                colour_xend = "red") +
  theme_minimal() + 
  labs(title = "Cambio en la Población de Riesgo",
       subtitle = "2004 to 2020",
       x = "Población en Riesgo",
       y = "Región")
```



# Clustering en "grupos de riesgo":

[NO HAY MANERA DE QUE SALGA ALGO DECENTE]

```{r, echo = FALSE, fig.align = "center", message = FALSE, warning=FALSE}
data_speech <- data[,40:63]
data_speech <-lapply(data_speech,as.numeric)
data_speech_scaled <- scale(as_tibble(data_speech))

#fviz_nbclust(x = data_speech_scaled, FUNcluster = kmeans, method = "wss",
# diss = dist(data_speech_scaled, method = "manhattan")) +
# geom_vline(xintercept = 3, linetype = 2)


#pam_clusters <- pam(x = data_speech_scaled, k = 3, metric = "euclidean")
#pam_clusters

#clusplot(data_speech_scaled, pam_clusters$cluster, lines = 0, shade = TRUE, color = #TRUE, labels = 1, plotchar = FALSE, span = TRUE, main = "Clustering")

hkmeans_cluster <- hkmeans(x = data_speech_scaled, hc.metric = "binary",
 hc.method = "complete", k = 4)
fviz_cluster(object = hkmeans_cluster, pallete = "jco", repel = TRUE) +
 theme_bw() + labs(title = "Hierarchical k-means Cluster plot")

table(hkmeans_cluster$cluster, data$disease, dnn = list("clusters", "enfermedad padecida"))

data_speech_scaled <- data_speech_scaled[hkmeans_cluster$cluster != 2,]
#AQUÍ HEMOS QUITADO LOS DATOS DEL CLUSTER SEPARADO QUE SON "OUTLIERS"

hkmeans_cluster2 <- hkmeans(x = data_speech_scaled, hc.metric = "binary",
 hc.method = "complete", k = 4)
fviz_cluster(object = hkmeans_cluster2, pallete = "jco", repel = TRUE) +
 theme_bw() + labs(title = "Hierarchical k-means Cluster plot")

table(hkmeans_cluster2$cluster, data[hkmeans_cluster$cluster != 2,]$disease, dnn = list("clusters", "enfermedad padecida"))

#install.packages("vegan")
library(vegan)
bc.dist <- vegdist (as_tibble(data_speech), method = 'bray')
#bc.dist
#print (bc.dist, diag = TRUE)
clust <- agnes (sqrt (bc.dist), method = 'ward')
plot (clust, which.plot = 2)
groups <- cutree (clust, k = 4)
#groups
#table(groups, data$disease, dnn = list("clusters", "enfermedad padecida"))
clusplot(as_tibble(data_speech), groups, lines = 0, shade = TRUE, color = TRUE, labels = 1, plotchar = FALSE, span = TRUE, main = "Clustering")
```

```{r, echo = FALSE, fig.show = "hold", fig.align = "center", message = FALSE, warning=FALSE}
#install.packages("pheatmap")
library("pheatmap")
pheatmap(as_tibble(data_speech), scale = "row")
#vaya ñordo

# Pairwise correlation between samples (columns)
cols.cor <- cor(as_tibble(data_speech), use = "pairwise.complete.obs", method = "pearson")
# Pairwise correlation between rows (genes)
rows.cor <- cor(t(as_tibble(data_speech)), use = "pairwise.complete.obs", method = "pearson")

# Plot the heatmap
library("pheatmap")
pheatmap(
  as_tibble(data_speech), scale = "row", 
  clustering_distance_cols = as.dist(1 - cols.cor),
  clustering_distance_rows = as.dist(1 - rows.cor)
  )
#QUÉ ES ESTO XDD

dist2 = function(x) as.dist(1-cor(t(x), method="pearson"))
hola <- hclust(dist2(as_tibble(data_speech)), method="ward.D")
plot (hola, which.plot = 2)
groups <- cutree (hola, k = 4)
groups
#clusplot(as_tibble(data_speech), hola)
table(groups, data$disease, dnn = list("clusters", "enfermedad padecida"))
clusplot(as_tibble(data_speech), groups, lines = 0, shade = TRUE, color = TRUE, labels = 1, plotchar = FALSE, span = TRUE, main = "Clustering")
```


